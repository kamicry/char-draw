# 字符画宽高比修复说明

## 问题描述

在字符画生成过程中，生成的图片不保持原图的宽高比，导致图片被拉伸或压缩。

### 问题示例
- 原图尺寸：1002 x 922 (宽高比 ≈ 1.087)
- 生成字符画尺寸：1155 x 2059 (宽高比 ≈ 0.56)
- **宽高比误差：约 45%**

## 根本原因

等宽字体的字符**不是正方形**，通常字符的宽度约为高度的 **0.5-0.6 倍**。

在原有实现中：
1. 将原图按比例缩放到目标宽度（如 150 像素）
2. 按像素创建字符网格（150 x 138 字符）
3. 渲染时每个字符占据的空间是 `char_width x char_height`
4. 由于 `char_width < char_height`，最终渲染的图片高度被拉长

### 示例计算（修复前）

假设字体大小 14px，字符宽度约 7.7px：
- 字符网格：150 x 138
- 最终图片宽度：150 × 7.7 ≈ 1155px
- 最终图片高度：138 × 14 ≈ 1932px
- 最终宽高比：1155 / 1932 ≈ 0.598
- **与原图比例相差 45%**

## 解决方案

引入 **字体宽高比补偿系数**（`FONT_ASPECT_RATIO`），在计算字符网格尺寸时对高度进行补偿。

### 核心思路

在将图片缩放为字符网格时，将计算出的高度乘以字体宽高比补偿系数（0.55），从而减少字符行数。这样当渲染时，虽然每个字符较高，但由于行数少了，最终图片的宽高比就能与原图保持一致。

### 代码实现

```python
# 添加字体宽高比补偿系数
FONT_ASPECT_RATIO = 0.55

# 在 _get_pic_text 方法中应用补偿
if w > new_w:
    # 计算按比例缩放后的高度
    new_h = int(new_w * h / w)
    # 应用字体宽高比补偿，减少行数以抵消字符高度大于宽度的影响
    new_h = int(new_h * FONT_ASPECT_RATIO)
    img = img.resize((new_w, new_h))
else:
    # 如果图片宽度小于目标宽度，保持宽度不变
    # 同样需要应用字体宽高比补偿
    new_h = int(h * FONT_ASPECT_RATIO)
    img = img.resize((w, new_h))
```

### 示例计算（修复后）

- 字符网格：150 x 75 (138 × 0.55 ≈ 75)
- 最终图片宽度：150 × 7.7 ≈ 1155px
- 最终图片高度：75 × 14 ≈ 1050px
- 最终宽高比：1155 / 1050 ≈ 1.100
- **与原图比例误差仅 1.2%**

## 测试结果

| 测试用例 | 原图尺寸 | 原图比例 | 生成图片比例 | 误差 | 状态 |
|---------|---------|---------|------------|------|-----|
| 16:9 横向 | 1920x1080 | 1.778 | 1.793 | 0.9% | ✅ |
| 9:16 竖向 | 1080x1920 | 0.562 | 0.565 | 0.5% | ✅ |
| 1:1 正方形 | 1000x1000 | 1.000 | 1.006 | 0.6% | ✅ |
| 16:9 宽屏 | 1600x900 | 1.778 | 1.793 | 0.9% | ✅ |
| 原始案例 | 1002x922 | 1.087 | 1.100 | 1.2% | ✅ |

所有测试用例的宽高比误差均小于 **5%**，远低于修复前的 **45%**。

## 影响范围

此修复同时适用于：
- ✅ 静态图片字符画生成
- ✅ GIF 动图字符画生成（每一帧都会应用补偿）

## 验收标准

- ✅ 生成的字符画保持原图的宽高比例（误差 < 5%）
- ✅ 字符画看起来不被拉伸或压缩
- ✅ 对不同宽高比的原图都能正确处理
- ✅ 不影响现有功能（静态图和 GIF 都正常工作）
